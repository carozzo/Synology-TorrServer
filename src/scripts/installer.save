#!/bin/sh

USR="${SYNOPKG_PKGDEST}/db/accs.db"
PAS="${SYNOPKG_PKGDEST}/db/accs.db"
SSS="/var/packages/${SYNOPKG_PKGNAME}/scripts/start-stop-status"
FWPORTS_FILE="/var/packages/${SYNOPKG_PKGNAME}/conf/${SYNOPKG_PKGNAME}.sc"

# Tools shortcuts
MV="/bin/mv -f"
RM="/bin/rm -rf"
MKDIR="/bin/mkdir -p"

preinst ()
{
exit 0
}

postinst ()
{
    if [ "${wizard_enable_aut}" == "false" ]; then
       exit 0
    else
       sed -i -e "s|@user@|${wizard_username:=admin}|g" ${USR}
       sed -i -e "s|@password@|${wizard_password:=admin}|g" ${PAS}
       #sed "/${SERVICE_COMMAND}/${SERVICE_COMMAND} -p ${PORT} -d ${DB} -a &{ACCS} &/" ${SSS}
 fi
        # Add firewall config
     if [ -r "${FWPORTS_FILE}" ]; then
        servicetool --install-configure-file --package "${FWPORTS_FILE}"
     fi
exit 0
}

preuninst ()
{

        # Stop the package
        ${SSS} stop > /dev/nul

        # Remove firewall config
        if [ "${SYNOPKG_PKG_STATUS}" == "UNINSTALL" ]; then
           if [ -r "${FWPORTS_FILE}" ]; then
               servicetool --remove-configure-file --package "${SYNOPKG_PKGNAME}.sc"
        fi
    fi

exit 0
}

postuninst ()
{
exit 0
}

preupgrade ()
{

    if [ "${wizard_update_data}" == "false" ]; then
        # Stop the package
        ${SSS} stop > /dev/null
        # Save some stuff
        $RM ${TMP_DIR}/${SYNOPKG_PKGNAME}
	$MKDIR ${TMP_DIR}/${SYNOPKG_PKGNAME}
	$MV ${SYNOPKG_PKGDEST}/db ${TMP_DIR}/${SYNOPKG_PKGNAME}/
 fi

exit 0
}

postupgrade ()
{

    if [ "${wizard_update_data}" == "false" ]; then
	# Restore some stuff
        $RM ${SYNOPKG_PKGDEST}/db
        $MV ${TMP_DIR}/${SYNOPKG_PKGNAME}/db ${SYNOPKG_PKGDEST}/db/
        $RM ${TMP_DIR}/${SYNOPKG_PKGNAME}
 fi

exit 0
}
